<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Shadow Hunter - Ultimate Evolution</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        #ui-overlay {
            position: absolute; top: 20px; width: 100%;
            color: white; pointer-events: none;
            text-shadow: 2px 2px 4px #000; font-family: 'Courier New', monospace;
        }
        .stat-right { position: absolute; right: 20px; top: 0; text-align: right; font-size: 18px; }
        .wave-center { position: absolute; left: 50%; transform: translateX(-50%); font-size: 32px; color: #ffcc00; font-weight: bold; letter-spacing: 2px; }
        
        #start-screen, #death-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; z-index: 10;
            text-align: center;
        }
        #death-screen { display: none; background: rgba(40, 0, 0, 0.95); }

        .btn-group { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; }
        
        .game-btn {
            padding: 15px 40px; font-size: 20px; font-weight: bold;
            background: #00ffff; color: #000; border: none; cursor: pointer;
            border-radius: 5px; box-shadow: 0 0 15px #00ffff;
            transition: 0.3s; min-width: 250px; pointer-events: auto;
        }
        .game-btn:hover { background: #fff; box-shadow: 0 0 30px #fff; transform: scale(1.05); }
        .btn-secondary { background: #555; color: white; box-shadow: 0 0 10px #333; }

        #skill-bar {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; pointer-events: none;
        }
        .skill-slot {
            width: 50px; height: 50px; background: rgba(0,0,0,0.7);
            border: 2px solid #00ffff; border-radius: 8px; position: relative;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #00ffff; overflow: hidden; font-size: 12px;
        }
        .cooldown-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.4);
            height: 0%;
        }
        .skill-key { position: absolute; top: 2px; left: 4px; font-size: 9px; color: #fff; }

        #minimap-container {
            position: absolute; bottom: 120px; right: 20px;
            width: 150px; height: 150px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffff; border-radius: 5px; overflow: hidden;
        }
        #minimap { width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="ui-overlay">
    <div class="wave-center">WAVE <span id="wave-num">1</span></div>
    <div class="stat-right">
        TIME: <span id="timer">00:00</span><br>
        KILLS: <span id="kill-count">0</span>
    </div>
</div>

<div id="skill-bar">
    <div class="skill-slot"><div class="skill-key">M0</div><div class="cooldown-overlay" id="cd-basic"></div>ATK</div>
    <div class="skill-slot"><div class="skill-key">1</div><div class="cooldown-overlay" id="cd-s1"></div>MULTI</div>
    <div class="skill-slot"><div class="skill-key">2</div><div class="cooldown-overlay" id="cd-s2"></div>NOVA</div>
    <div class="skill-slot"><div class="skill-key">3</div><div class="cooldown-overlay" id="cd-s3"></div>BLINK</div>
</div>

<div id="minimap-container"><canvas id="minimap"></canvas></div>

<div id="start-screen">
    <h1 style="font-size: 60px; color: #00ffff; margin-bottom: 0;">SHADOW HUNTER</h1>
    <p style="color: #00ffff; letter-spacing: 5px; margin-bottom: 40px;">ULTIMATE EVOLUTION</p>
    <button class="game-btn" onclick="startGame()">BẮT ĐẦU</button>
</div>

<div id="death-screen">
    <h1 style="font-size: 50px; color: #ff4444; margin-bottom: 10px;">BẠN ĐÃ TỬ TRẬN</h1>
    <div id="final-stats" style="font-size: 20px; margin-bottom: 20px;"></div>
    <div class="btn-group">
        <button class="game-btn" onclick="resetGame()">CHƠI LẠI</button>
        <button class="game-btn btn-secondary" onclick="backToMenu()">VỀ MÀN HÌNH CHÍNH</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap");
const mctx = mCanvas.getContext("2d");

const MAP_SIZE = 2000;
const timerEl = document.getElementById("timer");
const killEl = document.getElementById("kill-count");
const waveEl = document.getElementById("wave-num");

function resize() { 
    canvas.width = innerWidth; canvas.height = innerHeight; 
    mCanvas.width = 150; mCanvas.height = 150;
}
window.onresize = resize; resize();

let gameState = "MENU"; 
let startTime, kills, currentWave, enemiesToSpawn, enemiesRemaining;
let player, bullets, enemies, particles, damageTexts, shakeTime;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSfx(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    if (type === 'shoot') {
        osc.frequency.setValueAtTime(600, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'death') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    } else if (type === 'skill') {
        osc.type = 'square'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }
}

class Particle {
    constructor(x, y, color, size = 4) {
        this.x = x; this.y = y; this.color = color;
        this.size = Math.random() * size + 2;
        this.vx = (Math.random() - 0.5) * 10;
        this.vy = (Math.random() - 0.5) * 10;
        this.life = 1.0;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
    draw() {
        ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, 7); ctx.fill();
        ctx.globalAlpha = 1;
    }
}

class DamageText {
    constructor(x, y, text, color = "#ffffff") {
        this.x = x; this.y = y; this.text = text; this.color = color;
        this.life = 1.0; this.vy = -2;
    }
    update() { this.y += this.vy; this.life -= 0.02; }
    draw() {
        ctx.save();
        ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
        ctx.font = "bold 20px Arial"; ctx.textAlign = "center";
        ctx.fillText(this.text, this.x, this.y);
        ctx.restore();
    }
}

function initGame() {
    startTime = Date.now();
    kills = 0; currentWave = 1; shakeTime = 0;
    bullets = []; enemies = []; particles = []; damageTexts = [];
    player = {
        x: MAP_SIZE/2, y: MAP_SIZE/2, r: 18,
        angle: 0, speed: 3.8,
        level: 1, exp: 0, expNext: 100,
        maxHp: 200, hp: 200, damage: 35
    };
    killEl.innerText = "0";
    startNextWave();
}

function startGame() {
    document.getElementById("start-screen").style.display = "none";
    if (audioCtx.state === 'suspended') audioCtx.resume();
    initGame();
    gameState = "PLAYING";
}

function resetGame() {
    document.getElementById("death-screen").style.display = "none";
    initGame();
    gameState = "PLAYING";
}

function backToMenu() {
    document.getElementById("death-screen").style.display = "none";
    document.getElementById("start-screen").style.display = "flex";
    gameState = "MENU";
}

function gameOver() {
    gameState = "GAMEOVER";
    document.getElementById("death-screen").style.display = "flex";
    const minutes = Math.floor((Date.now() - startTime) / 60000);
    const seconds = Math.floor(((Date.now() - startTime) % 60000) / 1000);
    document.getElementById("final-stats").innerHTML = `
        <div style="color: #aaa;">Thời gian: <span style="color: #fff;">${minutes}p ${seconds}s</span></div>
        <div style="color: #aaa;">Kills: <span style="color: #fff;">${kills}</span></div>
        <div style="color: #aaa;">Level: <span style="color: #fff;">${player.level}</span></div>
    `;
}

function gainExp(amt) {
    player.exp += amt;
    if (player.exp >= player.expNext) {
        player.level++;
        player.exp -= player.expNext;
        player.expNext = Math.floor(player.expNext * 1.4);
        player.damage += 5;
        player.maxHp += 20;
        player.hp = player.maxHp;
        damageTexts.push(new DamageText(player.x, player.y - 30, "LEVEL UP!", "#00ffff"));
    }
}

const camera = { x: 0, y: 0, lerp: 0.1 };
const MONSTER_TYPES = [
    { r: 14, hp: 40, speed: 1.2, exp: 20, color: "#44ff44", chance: 0.4 },
    { r: 20, hp: 80, speed: 2.0, exp: 50, color: "#ffaa00", chance: 0.7 },
    { r: 18, hp: 60, speed: 3.2, exp: 60, color: "#aaaaaa", chance: 0.85 },
    { r: 35, hp: 300, speed: 1.0, exp: 200, color: "#8844ff", chance: 0.95 },
    { r: 55, hp: 1500, speed: 1.5, exp: 1000, color: "#ff0000", chance: 1.0 }
];

const skills = {
    basic: { cd: 200, last: 0, color: "#ffcc00", el: "cd-basic" },
    s1: { cd: 1000, last: 0, color: "#00ffcc", el: "cd-s1" },
    s2: { cd: 4000, last: 0, color: "#ff4400", el: "cd-s2" },
    s3: { cd: 7000, last: 0, color: "#aa00ff", el: "cd-s3" }
};

const keys = {}, mouse = { x: 0, y: 0, wx: 0, wy: 0, down: false };
onkeydown = e => keys[e.code] = true;
onkeyup = e => keys[e.code] = false;
onmousemove = e => {
    mouse.x = e.clientX; mouse.y = e.clientY;
    mouse.wx = mouse.x + camera.x; mouse.wy = mouse.y + camera.y;
};
onmousedown = e => { if (e.button === 0) mouse.down = true; };
onmouseup = e => { if (e.button === 0) mouse.down = false; };

function startNextWave() {
    enemiesToSpawn = 10 + (currentWave * 5);
    enemiesRemaining = enemiesToSpawn;
    waveEl.innerText = currentWave;
}

function spawnEnemy() {
    if (gameState !== "PLAYING" || enemiesToSpawn <= 0) return;
    const rand = Math.random();
    let type = MONSTER_TYPES[0];
    for (const t of MONSTER_TYPES) { if (rand < t.chance) { type = t; break; } }
    
    let ex, ey;
    const side = Math.floor(Math.random() * 4);
    const margin = 30; 
    if(side === 0) { ex = Math.random() * MAP_SIZE; ey = margin; }
    else if(side === 1) { ex = MAP_SIZE - margin; ey = Math.random() * MAP_SIZE; }
    else if(side === 2) { ex = Math.random() * MAP_SIZE; ey = MAP_SIZE - margin; }
    else { ex = margin; ey = Math.random() * MAP_SIZE; }

    enemies.push({
        ...type, x: ex, y: ey,
        hp: type.hp * (1 + (currentWave-1)*0.3),
        maxHp: type.hp * (1 + (currentWave-1)*0.3),
        dmg: (type.r/5), expReward: type.exp
    });
    enemiesToSpawn--;
}

function shoot(dmg, color, size = 6, angleOffset = 0) {
    const a = Math.atan2(mouse.wy - player.y, mouse.wx - player.x) + angleOffset;
    bullets.push({ x: player.x, y: player.y, vx: Math.cos(a)*15, vy: Math.sin(a)*15, dmg, size, color, dist: 0 });
    playSfx('shoot');
}

function update() {
    if (gameState !== "PLAYING") return;

    timerEl.innerText = Math.floor((Date.now() - startTime)/1000) + "s";

    let mx = 0, my = 0;
    if (keys.KeyW) my--; if (keys.KeyS) my++; if (keys.KeyA) mx--; if (keys.KeyD) mx++;
    if (mx || my) {
        const l = Math.hypot(mx, my);
        player.x += mx / l * player.speed; player.y += my / l * player.speed;
    }
    player.x = Math.max(player.r, Math.min(MAP_SIZE - player.r, player.x));
    player.y = Math.max(player.r, Math.min(MAP_SIZE - player.r, player.y));
    player.angle = Math.atan2(mouse.wy - player.y, mouse.wx - player.x);
    
    let targetCamX = player.x - canvas.width / 2;
    let targetCamY = player.y - canvas.height / 2;
    camera.x += (Math.max(0, Math.min(MAP_SIZE - canvas.width, targetCamX)) - camera.x) * camera.lerp;
    camera.y += (Math.max(0, Math.min(MAP_SIZE - canvas.height, targetCamY)) - camera.y) * camera.lerp;

    if (shakeTime > 0) { camera.x += (Math.random()-0.5)*15; camera.y += (Math.random()-0.5)*15; shakeTime--; }

    const t = Date.now();
    for(let k in skills) {
        let s = skills[k];
        let remain = Math.max(0, s.cd - (t - s.last));
        document.getElementById(s.el).style.height = (remain / s.cd * 100) + "%";
    }

    if (mouse.down && t - skills.basic.last > skills.basic.cd) { shoot(player.damage, skills.basic.color); skills.basic.last = t; }
    if (keys.Digit1 && t - skills.s1.last > skills.s1.cd) { for (let i=-0.3; i<=0.3; i+=0.3) shoot(player.damage, skills.s1.color, 6, i); skills.s1.last = t; playSfx('skill'); }
    if (keys.Digit2 && t - skills.s2.last > skills.s2.cd) {
        for (let i=0; i<16; i++) bullets.push({ x: player.x, y: player.y, vx: Math.cos(i*Math.PI/8)*11, vy: Math.sin(i*Math.PI/8)*11, dmg: player.damage*2, size: 8, color: skills.s2.color, dist: 0 });
        shakeTime = 10; skills.s2.last = t; playSfx('skill');
    }
    if (keys.Digit3 && t - skills.s3.last > skills.s3.cd) {
        const dist = Math.min(Math.hypot(mouse.wx-player.x, mouse.wy-player.y), 350);
        const ang = Math.atan2(mouse.wy-player.y, mouse.wx-player.x);
        player.x += Math.cos(ang)*dist; player.y += Math.sin(ang)*dist;
        enemies.forEach((e, ei) => { 
            if(Math.hypot(player.x-e.x, player.y-e.y) < 180) { 
                let d = Math.floor(player.damage*5);
                e.hp -= d; damageTexts.push(new DamageText(e.x, e.y, d, "#ff00ff"));
                if(e.hp<=0) {
                    playSfx('death'); for(let p=0; p<10; p++) particles.push(new Particle(e.x, e.y, e.color));
                    enemies.splice(ei, 1); kills++; enemiesRemaining--; gainExp(e.expReward);
                } 
            } 
        });
        shakeTime = 15; skills.s3.last = t; playSfx('skill');
    }

    bullets.forEach((b, bi) => {
        b.x += b.vx; b.y += b.vy; b.dist += 15;
        if(b.dist > 1000) bullets.splice(bi, 1);
        enemies.forEach((e, ei) => {
            if(Math.hypot(b.x-e.x, b.y-e.y) < e.r + b.size) {
                let d = Math.floor(b.dmg);
                e.hp -= d; damageTexts.push(new DamageText(e.x, e.y, d));
                bullets.splice(bi, 1);
                if(e.hp <= 0) {
                    playSfx('death'); for(let p=0; p<10; p++) particles.push(new Particle(e.x, e.y, e.color));
                    enemies.splice(ei, 1); kills++; enemiesRemaining--; gainExp(e.expReward);
                }
            }
        });
    });

    enemies.forEach((e) => {
        const d = Math.hypot(player.x-e.x, player.y-e.y);
        e.x += (player.x-e.x)/d * e.speed; e.y += (player.y-e.y)/d * e.speed;
        if(d < e.r + player.r) { player.hp -= 0.5; if(player.hp <= 0) gameOver(); }
    });

    if(enemiesRemaining <= 0 && enemies.length === 0) { currentWave++; startNextWave(); }
    particles.forEach((p, i) => { p.update(); if (p.life <= 0) particles.splice(i, 1); });
    damageTexts.forEach((dt, i) => { dt.update(); if (dt.life <= 0) damageTexts.splice(i, 1); });
    killEl.innerText = kills;
}

function draw() {
    ctx.fillStyle = "#0a0a0f";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (gameState === "MENU") return;

    ctx.save(); ctx.translate(-camera.x, -camera.y);
    
    // --- VẼ Ô LY (GRID) ---
    ctx.strokeStyle = "rgba(0, 255, 255, 0.1)";
    ctx.lineWidth = 1;
    for(let i=0; i<=MAP_SIZE; i+=100) {
        ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, MAP_SIZE); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(MAP_SIZE, i); ctx.stroke();
    }
    ctx.strokeStyle = "#0ff"; ctx.lineWidth = 4; ctx.strokeRect(0,0,MAP_SIZE,MAP_SIZE);

    // Objects
    bullets.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, 7); ctx.fill(); });
    particles.forEach(p => p.draw());
    damageTexts.forEach(dt => dt.draw());

    enemies.forEach(e => {
        if(e.hp > 0) {
            ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, 7); ctx.fill();
            ctx.fillStyle = "#333"; ctx.fillRect(e.x-15, e.y-e.r-10, 30, 4);
            ctx.fillStyle = "#f00"; ctx.fillRect(e.x-15, e.y-e.r-10, 30*(e.hp/e.maxHp), 4);
        }
    });

    // Player
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    ctx.fillStyle = "#0ff"; ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-15,-12); ctx.lineTo(-15,12); ctx.fill();
    ctx.restore();
    ctx.restore();

    // UI TRÊN MÀN HÌNH (STATIC UI)
    mctx.clearRect(0,0,150,150);
    const s = 150/MAP_SIZE;
    mctx.fillStyle = "#0ff"; mctx.beginPath(); mctx.arc(player.x*s, player.y*s, 3, 0, 7); mctx.fill();
    mctx.fillStyle = "#f00"; enemies.forEach(e => mctx.fillRect(e.x*s, e.y*s, 2, 2));

    if(gameState === "PLAYING") {
        const uiX = 30;
        const uiY = canvas.height - 60;
        
        // --- HIỂN THỊ LEVEL & INFO ---
        ctx.fillStyle = "#fff";
        ctx.font = "bold 16px Arial";
        ctx.textAlign = "left";
        ctx.fillText(`LEVEL: ${player.level}  |  DAMAGE: ${player.damage}`, uiX, uiY - 10);

        // --- THANH MÁU (HP BAR) ---
        ctx.fillStyle = "#333"; 
        ctx.fillRect(uiX, uiY, 250, 25);
        ctx.fillStyle = "#f36"; 
        ctx.fillRect(uiX, uiY, 250 * (player.hp / player.maxHp), 25);
        
        // Chữ máu hiện ở giữa thanh
        ctx.fillStyle = "#fff";
        ctx.font = "bold 12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(`${Math.ceil(player.hp)} / ${player.maxHp}`, uiX + 125, uiY + 17);

        // --- THANH KINH NGHIỆM (EXP BAR) ---
        ctx.fillStyle = "rgba(0,0,0,0.5)"; 
        ctx.fillRect(uiX, uiY + 30, 250, 8);
        ctx.fillStyle = "#fd0"; 
        ctx.fillRect(uiX, uiY + 30, 250 * (player.exp / player.expNext), 8);
    }
}

setInterval(spawnEnemy, 600);
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>